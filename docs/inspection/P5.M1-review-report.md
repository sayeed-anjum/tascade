# P5.M1 Metrics Artifacts Review Report

**Date:** 2026-02-08  
**Reviewer:** Tascade Dogfooding Agent (File Search Specialist)  
**Status:** Conditional Pass (Requires Consistency Fixes)

## 1. Executive Summary

The P5.M1 metrics definition phase has produced a comprehensive set of artifacts including a catalogue, formulas, source mappings, API contract, and DQ rules. 

**Strengths:**
- **Technical Correctness:** Formulas and SQL mappings are technically sound and aligned with the database schema (`schema-v0.1.sql`).
- **Completeness:** The definitions cover the full lifecycle of metrics from raw event data to API presentation.
- **Traceability:** Clear lineage from business value (Catalogue) to implementation (Source Mapping).

**Critical Findings:**
- **Scope Inconsistency:** There is a significant mismatch between the frozen MVP scope (T9) and the API Contract (T7). The API contract includes metrics that have been explicitly deferred or excluded from MVP.
- **Ambiguity:** T9 (Scope Release) contains contradictory information regarding OP-9 and OP-12 (listed as deferred but annotated as "should be in MVP").
- **Implementation Gaps:** The Data Quality validation script (`validate_dq_rules.py`) implements less than 30% of the rules defined in the Rulebook (T8).

## 2. Consistency Check Results

The following matrix highlights discrepancies across the artifacts. The **T9 (MVP Scope)** column represents the authoritative freeze.

| Metric | T4 (Catalogue) | T5 (Formulas) | T6 (Source Map) | T7 (API Contract) | T9 (MVP Scope) | Status |
|--------|----------------|---------------|-----------------|-------------------|----------------|--------|
| **NS-1..5** | P0/P1 (In) | Defined | Mapped | Included | **In Scope** | ✅ Consistent |
| **OP-1..6** | P0/P1 (In) | Defined | Mapped | Included | **In Scope** | ✅ Consistent |
| **OP-7** | P1 (In) | Defined | Mapped | Included | **Deferred** | ❌ T7 includes deferred metric |
| **OP-8** | P2 (Excl) | Excluded | Mapped | Included | **Deferred** | ❌ T7 includes excluded metric |
| **OP-9** | P0 (In) | Defined | Mapped | Included | **Ambiguous** | ⚠️ T9 contradictory |
| **OP-10** | P2 (Excl) | Excluded | Mapped | Included | **Deferred** | ❌ T7 includes excluded metric |
| **OP-11** | P2 (Excl) | Excluded | Mapped | Included | **Deferred** | ❌ T7 includes excluded metric |
| **OP-12** | P0 (In) | Defined | Mapped | Missing | **Ambiguous** | ⚠️ T9 contradictory & T7 missing |
| **ACT-1** | P1 (In) | Defined | Mapped | Included | **Deferred** | ❌ T7 includes deferred metric |
| **ACT-2** | P1 (In) | Defined | Mapped | Included | **In Scope** | ✅ Consistent |
| **ACT-4** | P1 (In) | Defined | Mapped | Included* | **Deferred** | ❌ T7 includes deferred metric |
| **ACT-5** | P2 (Excl) | Excluded | Mapped | Included* | **Deferred** | ❌ T7 includes excluded metric |
| **ACT-6** | P1 (In) | Defined | Mapped | Included* | **In Scope** | ✅ Consistent |
| **ACT-7** | P1 (In) | Defined | Mapped | Included | **In Scope** | ✅ Consistent |

*\*Included as an enum value in `suggested_actions`*

## 3. Technical Findings

### 3.1 API Contract (T7) & Types (T7 Code)
- **Scope Creep:** `web/src/types/metrics.ts` and `docs/metrics/api-contract-v1.md` define a "superset" API that includes `review_throughput` (OP-8), `replan_churn` (OP-10), `dependency_risk` (OP-11), and `task_split` suggestions (ACT-5). These are P2/Deferred metrics. Implementing the API as specified would require implementing these excluded metrics.
- **Missing Metric:** OP-12 (State Distribution) is In-Scope (or Ambiguous) but appears to be missing a dedicated field in the `OperationalMetrics` schema, unless it is intended to be covered partially by `wip`.

### 3.2 Data Quality (T8)
- **Script Coverage:** `scripts/validate_dq_rules.py` only validates 6 tables (`project`, `task`, `dependency_edge`, `lease`, `artifact`, `gate_decision`). The Rulebook defines rules for 13 additional streams (including `event_log`, `plan_change_set`, `api_key`) which are unchecked.
- **Logic:** The implemented checks are sound and use efficient SQL aggregation.

### 3.3 Source Mapping (T6) & Schema
- **Validity:** The field references in T6 (e.g., `task.task_class`, `dependency_edge.unlock_on`) match the postgres schema definitions in `docs/db/schema-v0.1.sql`.
- **Enums:** Enum values for `task_state` and `task_class` are consistent across Schema, Mapping, and Validation script.

## 4. Recommendations

### Must Fix (Before P5.M2 Implementation)
1.  **Reconcile API Contract (T7) with MVP Scope (T9):**
    - Remove `review_throughput`, `replan_churn`, `dependency_risk` from `OperationalMetrics` in T7 and `web/src/types/metrics.ts`.
    - Remove `breach_forecast` from `ActionabilityMetrics` (ACT-1 is deferred).
    - Remove `batch_merge` and `split_task` from `suggested_actions` enum.
    - **Rationale:** Implementing the API as currently defined would violate the scope freeze.

2.  **Clarify OP-9 and OP-12 Status in T9:**
    - Update `docs/metrics/mvp-scope-release-v1.md` to explicitly state if Integration Outcome Mix (OP-9) and State Distribution (OP-12) are IN or OUT. The current document contradicts itself (Note says "Should be in MVP", Table excludes them).

3.  **Ensure OP-12 is in API (if Scope = IN):**
    - If OP-12 is decided as IN, add `state_distribution` to the `OperationalMetrics` schema in T7.

### High Priority (During P5.M2)
4.  **Expand DQ Validation:**
    - Create a follow-up task to implement validation logic for `event_log` and `integration_attempt` in `validate_dq_rules.py`, as these are critical for the in-scope metrics (NS-2, NS-3, OP-1, OP-2, OP-3).

## 5. Checked Files
1.  `docs/metrics/metrics-catalogue-v1.md`
2.  `docs/metrics/metric-formulas-v1.md`
3.  `docs/metrics/source-mapping-v1.md`
4.  `docs/metrics/api-contract-v1.md`
5.  `web/src/types/metrics.ts`
6.  `docs/metrics/dq-rulebook-v1.md`
7.  `scripts/validate_dq_rules.py`
8.  `docs/metrics/mvp-scope-release-v1.md`
9.  `docs/db/schema-v0.1.sql`
